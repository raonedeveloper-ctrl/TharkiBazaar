<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TharkiBazaar</title>
  <meta name="description" content="TharkiBazaar mobile-first landing page with blurred previews, Terabox downloads, and admin controls.">
  <style>
    :root{
      --bg:#eef1f6;
      --text:#0f172a;
      --card:#ffffff;
      --line:#d8dee9;
      --muted:#5d6471;
      --button:#2563eb;
      --button-hover:#1d4ed8;
      --pill:#e2e8f0;
      --accent:#f1f5ff;
      --blur-strength:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:"Segoe UI",Arial,sans-serif;
      line-height:1.55;
      padding-bottom:120px;
      transition:background 0.2s ease;
    }
    body.admin-mode{
      padding-bottom:80px;
    }
    body.admin-overlay-active{
      overflow:hidden;
    }
    a{text-decoration:none;color:inherit;}
    header{
      padding:26px 16px 14px;
      text-align:center;
      font-weight:800;
      font-size:clamp(1.8rem,2vw + 1rem,2.8rem);
      letter-spacing:0.08em;
      cursor:default;
      user-select:none;
    }
    header span{display:inline-block;}
    [hidden]{display:none !important;}
    .page{
      max-width:1300px;
      margin:0 auto;
      padding:0 20px 40px;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:0 10px 24px rgba(15,23,42,0.05);
    }
    .layout{
      display:flex;
      flex-direction:column;
      gap:24px;
      align-items:stretch;
    }
    .main-column{
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .gallery{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:20px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      padding:16px;
      transition:transform 0.18s ease, box-shadow 0.18s ease;
      overflow:hidden;
    }
    .card.ad-card{
      justify-content:center;
      min-height:180px;
      gap:0;
      padding:12px;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 18px 32px rgba(15,23,42,0.09);
    }
    .thumb{
      position:relative;
      background:var(--accent);
      border-radius:14px;
      overflow:hidden;
      width:100%;
      min-height:210px;
    }
    .thumb::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(15,23,42,0.12),rgba(15,23,42,0.32));
      pointer-events:none;
    }
    @supports (aspect-ratio: 3 / 4){
      .thumb{
        min-height:auto;
        aspect-ratio:3 / 4;
      }
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center top;
      filter:blur(var(--blur-strength));
      transform:scale(1.08);
      pointer-events:none;
      user-select:none;
    }
    .eye-off{
      position:absolute;
      top:10px;
      right:10px;
      background:rgba(15,23,42,0.78);
      border-radius:999px;
      padding:6px 7px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 12px rgba(15,23,42,0.25);
      z-index:2;
    }
    .eye-off svg{
      display:block;
      width:20px;
      height:20px;
      fill:#f8fafc;
    }
    .card-body{
      padding:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      align-items:center;
      text-align:center;
    }
    .card-title{
      font-size:0.9rem;
      font-weight:600;
      color:var(--muted);
      letter-spacing:0.02em;
    }
    .card-actions{
      display:flex;
      justify-content:center;
      margin-top:auto;
      width:100%;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:var(--button);
      color:#fff;
      font-weight:600;
      border-radius:14px;
      padding:10px 18px;
      min-width:0;
      width:100%;
      max-width:200px;
      font-size:0.95rem;
      transition:background 0.2s ease, transform 0.2s ease;
      box-shadow:0 8px 18px rgba(37,99,235,0.18);
    }
    .btn:hover{background:var(--button-hover);}
    .btn:focus-visible{
      outline:3px solid rgba(37,99,235,0.35);
      outline-offset:2px;
    }
    .btn.ghost{
      background:transparent;
      color:var(--button);
      box-shadow:none;
      border:1px solid rgba(37,99,235,0.25);
    }
    .btn.destructive{
      background:#dc2626;
      box-shadow:0 8px 18px rgba(220,38,38,0.28);
    }
    .btn.destructive:hover{
      background:#b91c1c;
    }
    .ad-slot{
      width:100%;
      min-height:60px;
      border:1px dashed #cbd5e1;
      border-radius:14px;
      background:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding:8px;
      position:relative;
    }
    .ad-slot span{
      font-size:0.85rem;
      color:var(--muted);
      opacity:0.8;
    }
    .ad-slot iframe{
      display:block;
      margin:0 auto;
      border:0;
      width:100%;
      max-width:100%;
    }
    .responsive-ad-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
    }
    .admin-indicator{
      position:fixed;
      top:16px;
      right:16px;
      background:rgba(29,78,216,0.95);
      color:#fff;
      padding:9px 18px;
      border-radius:999px;
      font-size:0.78rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      box-shadow:0 12px 24px rgba(29,78,216,0.28);
      z-index:520;
    }
    .floating-admin-btn{
      position:fixed;
      bottom:24px;
      right:24px;
      padding:12px 20px;
      border-radius:999px;
      background:var(--button);
      color:#fff;
      font-weight:600;
      border:none;
      cursor:pointer;
      box-shadow:0 16px 32px rgba(37,99,235,0.25);
      z-index:510;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .floating-admin-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 20px 40px rgba(37,99,235,0.3);
    }
    .admin-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.72);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:40px 16px;
      z-index:600;
      overflow-y:auto;
    }
    .admin-panel{
      width:min(920px,100%);
      background:#fff;
      border-radius:20px;
      padding:28px;
      box-shadow:0 24px 60px rgba(15,23,42,0.3);
      display:flex;
      flex-direction:column;
      gap:28px;
    }
    .admin-header{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .admin-header-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      border-radius:999px;
      border:none;
      padding:10px 18px;
      background:var(--pill);
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease, color 0.2s ease;
    }
    .chip:hover{
      background:var(--button);
      color:#fff;
    }
    .chip.destructive{
      background:#fee2e2;
      color:#b91c1c;
    }
    .chip.destructive:hover{
      background:#dc2626;
      color:#fff;
    }
    .admin-section{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .admin-section h3{
      font-size:1.1rem;
      font-weight:700;
      letter-spacing:0.04em;
      color:var(--muted);
      text-transform:uppercase;
    }
    .form-grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    }
    .form-grid label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:0.85rem;
      color:var(--muted);
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .form-grid input,
    .form-grid select{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:0.95rem;
      color:var(--text);
      background:#fff;
      box-shadow:0 4px 12px rgba(15,23,42,0.05) inset;
      outline:none;
      transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    .form-grid input:focus,
    .form-grid select:focus{
      border-color:var(--button);
      box-shadow:0 0 0 3px rgba(37,99,235,0.18);
    }
    .admin-form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .admin-form-actions.wrap{
      justify-content:flex-start;
    }
    .visual-controls{
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width:320px;
    }
    .visual-controls input[type="range"]{
      accent-color:var(--button);
    }
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:16px;
    }
    .stats-card{
      padding:14px 16px;
      border-radius:14px;
      background:var(--accent);
      border:1px solid var(--line);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stats-card span{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .stats-card strong{
      font-size:1.4rem;
      font-weight:700;
    }
    .stats-details{
      border-radius:14px;
      background:var(--pill);
      padding:14px 16px;
      font-size:0.9rem;
      color:var(--muted);
      line-height:1.6;
    }
    .stats-details ul{
      margin-top:10px;
      list-style:disc;
      padding-left:20px;
      display:grid;
      gap:6px;
    }
    .admin-toast{
      position:fixed;
      bottom:110px;
      right:16px;
      background:#0f172a;
      color:#f8fafc;
      padding:12px 18px;
      border-radius:12px;
      font-size:0.85rem;
      box-shadow:0 12px 32px rgba(15,23,42,0.35);
      opacity:0;
      transform:translateY(12px);
      transition:opacity 0.25s ease, transform 0.25s ease;
      z-index:520;
    }
    .admin-toast.show{
      opacity:0.95;
      transform:translateY(0);
    }
    body.admin-mode .ad-section,
    body.admin-mode .ad-slot,
    body.admin-mode .ad-card{
      display:none !important;
    }
    @media (max-width:780px){
      .panel{padding:18px;}
      .gallery{grid-template-columns:repeat(2,minmax(0,1fr));}
      body{padding-bottom:160px;}
      .admin-panel{padding:22px;}
    }
    @media (max-width:520px){
      .gallery{grid-template-columns:repeat(1,minmax(0,1fr));}
      .btn{width:100%;}
      .admin-overlay{padding:32px 12px;}
      .admin-panel{padding:20px;}
    }
    @media (min-width:768px){
      .gallery{grid-template-columns:repeat(3,minmax(190px,1fr));}
    }
    @media (min-width:1200px){
      .gallery{grid-template-columns:repeat(5,minmax(190px,1fr));}
    }
  </style>
</head>
<body>
  <header>
    <span>TharkiBazaar</span>
  </header>
  <div id="admin-indicator" class="admin-indicator" hidden>ADMIN MODE</div>
  <main class="page">
    <section class="panel ad-section">
      <div id="slot-top" class="ad-slot ad-wrapper" data-slot="slot-top">
        <span>Advertisement</span>
      </div>
    </section>
    <div class="layout">
      <section class="main-column">
        <div class="panel">
          <div id="gallery" class="gallery"></div>
        </div>
        <section class="panel ad-section">
          <div id="slot-under-1" class="ad-slot ad-wrapper" data-slot="slot-under-1">
            <span>Advertisement</span>
          </div>
        </section>
        <section class="panel ad-section">
          <div id="slot-under-2" class="ad-slot ad-wrapper" data-slot="slot-under-2">
            <span>Advertisement</span>
          </div>
        </section>
        <section class="panel">
          <div class="responsive-ad-grid">
            <div id="slot-mobile-1" class="ad-slot ad-wrapper" data-slot="slot-mobile-1">
              <span>Advertisement</span>
            </div>
            <div id="slot-mobile-2" class="ad-slot ad-wrapper" data-slot="slot-mobile-2">
              <span>Advertisement</span>
            </div>
          </div>
        </section>
        <section class="panel ad-section">
          <div id="slot-bottom" class="ad-slot ad-wrapper" data-slot="slot-bottom">
            <span>Advertisement</span>
          </div>
        </section>
      </section>
    </div>
  </main>

  <button id="open-admin-panel" class="floating-admin-btn" hidden>Open Admin Panel</button>

  <div id="admin-overlay" class="admin-overlay" hidden>
    <div class="admin-panel">
      <header class="admin-header">
        <div>
          <h2>Admin Control Center</h2>
          <p style="color:var(--muted);max-width:520px;">
            Adjust gallery assets, tweak blur intensity, and manage analytics. Ads stay disabled while you are in admin mode.
          </p>
        </div>
        <div class="admin-header-actions">
          <button type="button" id="admin-close" class="chip">Close Panel</button>
          <button type="button" id="admin-logout" class="chip destructive">Log out</button>
        </div>
      </header>

      <section class="admin-section">
        <h3>Gallery Manager</h3>
        <form id="admin-image-form" class="form-grid">
          <label>
            Choose preview
            <select id="admin-image-select"></select>
          </label>
          <label>
            Title
            <input type="text" id="admin-image-title" maxlength="60" required>
          </label>
          <label>
            Image URL
            <input type="url" id="admin-image-url" placeholder="https://" required>
          </label>
          <label>
            Download URL
            <input type="url" id="admin-download-url" placeholder="https://" required>
          </label>
          <label>
            AI Hint (optional)
            <input type="text" id="admin-image-hint" maxlength="120">
          </label>
          <div class="admin-form-actions">
            <button type="submit" class="btn">Save changes</button>
            <button type="button" id="admin-reset-image" class="btn ghost">Reset selected</button>
          </div>
        </form>
      </section>

      <section class="admin-section">
        <h3>Visual Controls</h3>
        <div class="visual-controls">
          <label for="admin-blur">Blur strength: <span id="blur-value">12</span>px</label>
          <input type="range" id="admin-blur" min="0" max="25" step="1">
          <div class="admin-form-actions">
            <button type="button" id="reset-blur" class="btn ghost">Reset blur</button>
          </div>
        </div>
      </section>

      <section class="admin-section">
        <h3>Analytics</h3>
        <div class="stats-grid">
          <div class="stats-card">
            <span>Total Visits</span>
            <strong data-stat="visits">0</strong>
          </div>
          <div class="stats-card">
            <span>Downloads</span>
            <strong data-stat="downloads">0</strong>
          </div>
          <div class="stats-card">
            <span>Outbound Clicks</span>
            <strong data-stat="outbound">0</strong>
          </div>
          <div class="stats-card">
            <span>Ad Impressions</span>
            <strong data-stat="impressions">0</strong>
          </div>
          <div class="stats-card">
            <span>Ad Clicks</span>
            <strong data-stat="adclicks">0</strong>
          </div>
          <div class="stats-card">
            <span>Last Update</span>
            <strong data-stat="updated">--</strong>
          </div>
        </div>
        <div class="admin-form-actions wrap">
          <button type="button" id="stats-copy-link" class="btn ghost">Copy Smartlink</button>
          <button type="button" id="stats-refresh-ads" class="btn ghost">Refresh Ads</button>
          <button type="button" id="stats-export" class="btn ghost">Export JSON</button>
          <button type="button" id="stats-reset" class="btn destructive">Reset Stats</button>
        </div>
        <div class="stats-details" id="stats-details">
          No activity tracked yet. Interactions on this device will show up here.
        </div>
      </section>
    </div>
  </div>

  <div id="admin-toast" class="admin-toast" role="status" aria-live="assertive" hidden></div>

  <script src="https://pl27733128.revenuecpmgate.com/aa/5f/65/aa5f65bd170576514aff7ed9f749c09c.js"></script>
  <script src="https://pl27745183.revenuecpmgate.com/13/1f/fe/131ffed8b4e68b9b3eab58113d5a2ccf.js"></script>
  <script>
    (function(){
      const TERABOX_URL = 'https://www.1024tera.com/sharing/link?surl=PfOK7auKQ_ynPhfgWYjeqA&path=%2FAllVideos';
      const SMARTLINK_URL = 'https://www.revenuecpmgate.com/xf7ermdz85?key=b269d3dd076f7f0bc87132f84bb60eeb';
      const ADMIN_PASSWORD = 'Raone'; // replace before publishing
      const DEFAULT_BLUR = 12;

      const STORAGE_KEYS = {
        gallery: 'tharkibazaar.gallery.v2',
        blur: 'tharkibazaar.blur.v2',
        stats: 'tharkibazaar.metrics.v2',
        admin: 'tharkibazaar.admin.active',
      };

      const DEFAULT_GALLERY = [
        { id: 'preview-01', title: 'Preview 01', imageUrl: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, studio' },
        { id: 'preview-02', title: 'Preview 02', imageUrl: 'https://images.unsplash.com/photo-1524502397800-808dc0fef78d?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, fashion' },
        { id: 'preview-03', title: 'Preview 03', imageUrl: 'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'closeup, glamour' },
        { id: 'preview-04', title: 'Preview 04', imageUrl: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, smile' },
        { id: 'preview-05', title: 'Preview 05', imageUrl: 'https://images.unsplash.com/photo-1507692049790-de58290a4334?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'outdoor, summer' },
        { id: 'preview-06', title: 'Preview 06', imageUrl: 'https://images.unsplash.com/photo-1502767089025-6572583495b0?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, studio light' },
        { id: 'preview-07', title: 'Preview 07', imageUrl: 'https://images.unsplash.com/photo-1503342217505-b0a15ec3261c?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, mood' },
        { id: 'preview-08', title: 'Preview 08', imageUrl: 'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, neon' },
        { id: 'preview-09', title: 'Preview 09', imageUrl: 'https://images.unsplash.com/photo-1521570167421-1afc82db536a?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, casual' },
        { id: 'preview-10', title: 'Preview 10', imageUrl: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=900&q=80', downloadUrl: TERABOX_URL, imageHint: 'portrait, studio soft light' },
      ];

      const INLINE_ADS = [
        { afterIndex: 1, slotId: 'slot-inline-1' },
        { afterIndex: 3, slotId: 'slot-inline-2' },
      ];

      const AD_SCHEDULE = {
        'slot-top': { key: '518bb62c4fe828a47ab0530ed37ad2bf', width: 728, height: 90 },
        'slot-inline-1': { key: '72b7232ca3ae40f63836f3c472360365', width: 300, height: 250 },
        'slot-inline-2': { key: '72b7232ca3ae40f63836f3c472360365', width: 300, height: 250 },
        'slot-under-1': { key: '4e4e54cb42e36c5eb4dc8ab45feeefb9', width: 468, height: 60 },
        'slot-under-2': { key: '518bb62c4fe828a47ab0530ed37ad2bf', width: 728, height: 90 },
        'slot-mobile-1': { key: '72b7232ca3ae40f63836f3c472360365', width: 300, height: 250 },
        'slot-mobile-2': { key: 'b7193586f4106b807d27a90a71d22c37', width: 320, height: 50 },
        'slot-bottom': { key: 'b7193586f4106b807d27a90a71d22c37', width: 320, height: 50 },
      };

      const galleryContainer = document.getElementById('gallery');
      const adminIndicator = document.getElementById('admin-indicator');
      const adminOverlay = document.getElementById('admin-overlay');
      const openAdminButton = document.getElementById('open-admin-panel');
      const adminCloseButton = document.getElementById('admin-close');
      const adminLogoutButton = document.getElementById('admin-logout');
      const adminToast = document.getElementById('admin-toast');
      const imageForm = document.getElementById('admin-image-form');
      const imageSelect = document.getElementById('admin-image-select');
      const imageTitleInput = document.getElementById('admin-image-title');
      const imageUrlInput = document.getElementById('admin-image-url');
      const downloadUrlInput = document.getElementById('admin-download-url');
      const imageHintInput = document.getElementById('admin-image-hint');
      const resetImageButton = document.getElementById('admin-reset-image');
      const blurSlider = document.getElementById('admin-blur');
      const blurValueLabel = document.getElementById('blur-value');
      const resetBlurButton = document.getElementById('reset-blur');
      const statsCopyButton = document.getElementById('stats-copy-link');
      const statsRefreshButton = document.getElementById('stats-refresh-ads');
      const statsExportButton = document.getElementById('stats-export');
      const statsResetButton = document.getElementById('stats-reset');
      const statsDetails = document.getElementById('stats-details');

      const statsNodes = {
        visits: document.querySelector('[data-stat="visits"]'),
        downloads: document.querySelector('[data-stat="downloads"]'),
        outbound: document.querySelector('[data-stat="outbound"]'),
        impressions: document.querySelector('[data-stat="impressions"]'),
        adclicks: document.querySelector('[data-stat="adclicks"]'),
        updated: document.querySelector('[data-stat="updated"]'),
      };

      let selectedImageIndex = 0;
      let adminMode = false;
      let adminToastTimer = null;
      let adminToastHideTimer = null;
      let adObserver = null;

      let storageAvailable = true;
      try{
        const probeKey = '__tbz_probe__';
        localStorage.setItem(probeKey,'ok');
        localStorage.removeItem(probeKey);
      }catch(err){
        storageAvailable = false;
        console.warn('Local storage unavailable; customisations will not persist.', err);
      }

      function deepCopy(value){
        return JSON.parse(JSON.stringify(value));
      }

      function loadGallery(){
        if(!storageAvailable){ return deepCopy(DEFAULT_GALLERY); }
        try{
          const raw = localStorage.getItem(STORAGE_KEYS.gallery);
          if(!raw){ return deepCopy(DEFAULT_GALLERY); }
          const parsed = JSON.parse(raw);
          if(!Array.isArray(parsed) || !parsed.length){
            return deepCopy(DEFAULT_GALLERY);
          }
          return parsed.map((item, index) => ({
            ...DEFAULT_GALLERY[index] || deepCopy(DEFAULT_GALLERY[0]),
            ...item,
            id: DEFAULT_GALLERY[index] ? DEFAULT_GALLERY[index].id : item.id || `custom-${index + 1}`,
          }));
        }catch(err){
          console.warn('Failed to parse stored gallery', err);
          return deepCopy(DEFAULT_GALLERY);
        }
      }

      function saveGallery(){
        if(!storageAvailable){ return; }
        try{
          localStorage.setItem(STORAGE_KEYS.gallery, JSON.stringify(gallery));
        }catch(err){
          console.warn('Unable to persist gallery', err);
        }
      }

      function loadBlur(){
        if(!storageAvailable){ return DEFAULT_BLUR; }
        try{
          const raw = localStorage.getItem(STORAGE_KEYS.blur);
          const parsed = raw ? Number(raw) : DEFAULT_BLUR;
          return Number.isFinite(parsed) ? parsed : DEFAULT_BLUR;
        }catch(err){
          console.warn('Failed to load blur setting', err);
          return DEFAULT_BLUR;
        }
      }

      function saveBlur(value){
        if(!storageAvailable){ return; }
        try{
          localStorage.setItem(STORAGE_KEYS.blur, String(value));
        }catch(err){
          console.warn('Unable to persist blur preference', err);
        }
      }

      const defaultStats = {
        visits:0,
        downloads:0,
        outboundClicks:0,
        adImpressions:{},
        adClicks:{},
        downloadsPerItem:{},
        updated:null,
      };

      function loadStats(){
        if(!storageAvailable){ return deepCopy(defaultStats); }
        try{
          const raw = localStorage.getItem(STORAGE_KEYS.stats);
          if(!raw){ return deepCopy(defaultStats); }
          const parsed = JSON.parse(raw);
          return {
            ...deepCopy(defaultStats),
            ...parsed,
            adImpressions: { ...defaultStats.adImpressions, ...(parsed.adImpressions || {}) },
            adClicks: { ...defaultStats.adClicks, ...(parsed.adClicks || {}) },
            downloadsPerItem: { ...defaultStats.downloadsPerItem, ...(parsed.downloadsPerItem || {}) },
          };
        }catch(err){
          console.warn('Unable to parse stored stats', err);
          return deepCopy(defaultStats);
        }
      }

      function saveStats(){
        if(!storageAvailable){ return; }
        try{
          localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(stats));
        }catch(err){
          console.warn('Unable to persist stats', err);
        }
      }

      function loadAdminFlag(){
        if(!storageAvailable){ return false; }
        try{
          return sessionStorage.getItem(STORAGE_KEYS.admin) === '1';
        }catch(err){
          return false;
        }
      }

      function saveAdminFlag(enabled){
        if(!storageAvailable){ return; }
        try{
          if(enabled){
            sessionStorage.setItem(STORAGE_KEYS.admin,'1');
          }else{
            sessionStorage.removeItem(STORAGE_KEYS.admin);
          }
        }catch(err){
          console.warn('Unable to persist admin flag', err);
        }
      }

      let gallery = loadGallery();
      let blurStrength = loadBlur();
      let stats = loadStats();
      adminMode = loadAdminFlag();

      function applyBlur(value){
        document.documentElement.style.setProperty('--blur-strength', `${value}px`);
        blurSlider.value = String(value);
        blurValueLabel.textContent = String(value);
      }

      function createCard(item, index){
        const card = document.createElement('div');
        card.className = 'card';

        const thumb = document.createElement('div');
        thumb.className = 'thumb';

        const blurBadge = document.createElement('span');
        blurBadge.className = 'eye-off';
        blurBadge.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2.1 3.51 3.51 2.1l18.39 18.39-1.41 1.41-2.54-2.54A11.26 11.26 0 0 1 12 20.25c-4.6 0-8.6-2.73-11-7.25a12.77 12.77 0 0 1 4.11-4.59L2.1 3.51Zm12.24 12.24-1.74-1.74a2.75 2.75 0 0 1-3.62-3.62L7.61 7.88A7.49 7.49 0 0 0 4.2 12a9.73 9.73 0 0 0 3.47 3.7A9.63 9.63 0 0 0 12 17.5a7.49 7.49 0 0 0 2.34-.36ZM9.5 6.62l1.45 1.45a2.75 2.75 0 0 1 3.98 3.7l1.51 1.51A7.52 7.52 0 0 0 19.8 12a9.73 9.73 0 0 0-3.47-3.7A9.63 9.63 0 0 0 12 6.5a7.5 7.5 0 0 0-2.5.12Z"/></svg>';

        const img = document.createElement('img');
        img.src = item.imageUrl;
        img.alt = `${item.title} blurred preview`;
        img.loading = 'lazy';
        if(item.imageHint){
          img.dataset.aiHint = item.imageHint;
        }

        thumb.appendChild(blurBadge);
        thumb.appendChild(img);

        const body = document.createElement('div');
        body.className = 'card-body';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = item.title || `Preview ${String(index + 1).padStart(2,'0')}`;

        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const button = document.createElement('a');
        button.className = 'btn dl';
        button.href = item.downloadUrl || TERABOX_URL;
        button.target = '_blank';
        button.rel = 'noopener noreferrer nofollow';
        button.dataset.index = String(index);
        button.dataset.itemId = item.id;
        button.textContent = 'Download Now';

        actions.appendChild(button);
        body.appendChild(title);
        body.appendChild(actions);

        card.appendChild(thumb);
        card.appendChild(body);

        return card;
      }

      function createInlineAdSlot(slotId){
        const card = document.createElement('div');
        card.className = 'card ad-card ad-section';
        const slot = document.createElement('div');
        slot.className = 'ad-slot ad-wrapper';
        slot.id = slotId;
        slot.dataset.slot = slotId;
        slot.innerHTML = '<span>Advertisement</span>';
        card.appendChild(slot);
        return card;
      }

      function renderGallery(){
        galleryContainer.innerHTML = '';
        gallery.forEach((item, index) => {
          const card = createCard(item, index);
          galleryContainer.appendChild(card);
          const inline = INLINE_ADS.find(ad => ad.afterIndex === index);
          if(inline){
            const adCard = createInlineAdSlot(inline.slotId);
            galleryContainer.appendChild(adCard);
          }
        });
        attachDownloadListeners();
      }

      function attachDownloadListeners(){
        const buttons = galleryContainer.querySelectorAll('.btn.dl');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = Number(btn.dataset.index);
            const item = gallery[idx];
            if(item){
              trackDownload(item.id);
              trackOutbound(btn.href);
            }
          });
        });
      }

      function renderImageSelect(){
        imageSelect.innerHTML = '';
        gallery.forEach((item, index) => {
          const option = document.createElement('option');
          option.value = String(index);
          option.textContent = `${String(index + 1).padStart(2,'0')} - ${item.title}`;
          imageSelect.appendChild(option);
        });
        imageSelect.value = String(selectedImageIndex);
      }

      function populateImageForm(index){
        if(index < 0 || index >= gallery.length){
          index = 0;
        }
        selectedImageIndex = index;
        const item = gallery[index];
        imageTitleInput.value = item.title || '';
        imageUrlInput.value = item.imageUrl || '';
        downloadUrlInput.value = item.downloadUrl || TERABOX_URL;
        imageHintInput.value = item.imageHint || '';
        imageSelect.value = String(index);
      }

      function showAdminToast(message, duration){
        if(!adminToast){ return; }
        const displayMs = typeof duration === 'number' ? duration : 2200;
        adminToast.textContent = message;
        adminToast.hidden = false;
        adminToast.classList.add('show');
        if(adminToastTimer){ clearTimeout(adminToastTimer); }
        if(adminToastHideTimer){ clearTimeout(adminToastHideTimer); }
        adminToastTimer = setTimeout(() => {
          adminToast.classList.remove('show');
          adminToastHideTimer = setTimeout(() => {
            adminToast.hidden = true;
          }, 260);
        }, displayMs);
      }

      function openAdminPanel(){
        adminOverlay.hidden = false;
        document.body.classList.add('admin-overlay-active');
      }

      function closeAdminPanel(){
        adminOverlay.hidden = true;
        document.body.classList.remove('admin-overlay-active');
      }

      function setAdminUI(enabled){
        adminMode = enabled;
        document.body.classList.toggle('admin-mode', enabled);
        adminIndicator.hidden = !enabled;
        openAdminButton.hidden = !enabled;
        if(enabled){
          showAdminToast('Admin mode enabled');
        }
      }

      function promptAdminLogin(){
        if(adminMode){ openAdminPanel(); return; }
        const passphrase = window.prompt('Enter admin passphrase:');
        if(!passphrase){ return; }
        if(passphrase === ADMIN_PASSWORD){
          enableAdmin();
        }else{
          window.alert('Incorrect passphrase.');
        }
      }

      function enableAdmin(){
        saveAdminFlag(true);
        setAdminUI(true);
        clearAds();
        closeAdObserver();
        openAdminPanel();
      }

      function lockAdmin(){
        const wasActive = adminMode;
        saveAdminFlag(false);
        setAdminUI(false);
        closeAdminPanel();
        showAdminToast('Admin mode disabled', 1800);
        if(wasActive){
          refreshAllAds();
        }
      }

      function formatNumber(value){
        return typeof value === 'number' && typeof value.toLocaleString === 'function'
          ? value.toLocaleString()
          : String(value);
      }

      function renderStats(){
        if(statsNodes.visits){
          statsNodes.visits.textContent = formatNumber(stats.visits || 0);
        }
        if(statsNodes.downloads){
          statsNodes.downloads.textContent = formatNumber(stats.downloads || 0);
        }
        if(statsNodes.outbound){
          statsNodes.outbound.textContent = formatNumber(stats.outboundClicks || 0);
        }
        if(statsNodes.impressions){
          const totalImpressions = Object.values(stats.adImpressions || {}).reduce((sum, val) => sum + Number(val || 0), 0);
          statsNodes.impressions.textContent = formatNumber(totalImpressions);
        }
        if(statsNodes.adclicks){
          const totalAdClicks = Object.values(stats.adClicks || {}).reduce((sum, val) => sum + Number(val || 0), 0);
          statsNodes.adclicks.textContent = formatNumber(totalAdClicks);
        }
        if(statsNodes.updated){
          if(stats.updated){
            const parsed = new Date(stats.updated);
            statsNodes.updated.textContent = isNaN(parsed.getTime()) ? stats.updated : parsed.toLocaleString();
          }else{
            statsNodes.updated.textContent = '--';
          }
        }

        if(!statsDetails){ return; }
        const sections = [];
        const downloadsPerItem = Object.entries(stats.downloadsPerItem || {});
        if(downloadsPerItem.length){
          const items = downloadsPerItem
            .map(([id, count]) => {
              const idx = gallery.findIndex(item => item.id === id);
              const label = idx >= 0 ? gallery[idx].title || `Preview ${String(idx + 1).padStart(2,'0')}` : id;
              return `<li>${label}: ${formatNumber(count)}</li>`;
            })
            .join('');
          sections.push(`<strong>Downloads per preview</strong><ul>${items}</ul>`);
        }
        const impressionsPerSlot = Object.entries(stats.adImpressions || {});
        if(impressionsPerSlot.length){
          const items = impressionsPerSlot
            .sort()
            .map(([slot, count]) => `<li>${slot}: ${formatNumber(count)}</li>`)
            .join('');
          sections.push(`<strong>Ad impressions by slot</strong><ul>${items}</ul>`);
        }
        const adClicksPerSlot = Object.entries(stats.adClicks || {});
        if(adClicksPerSlot.length){
          const items = adClicksPerSlot
            .sort()
            .map(([slot, count]) => `<li>${slot}: ${formatNumber(count)}</li>`)
            .join('');
          sections.push(`<strong>Ad slot wrapper clicks</strong><ul>${items}</ul>`);
        }
        if(sections.length){
          statsDetails.innerHTML = `<strong>Stored locally on this device.</strong>${sections.join('')}`;
        }else{
          statsDetails.textContent = 'Stats are saved locally in this browser. Interact with downloads or ads to populate more detail.';
        }
      }
      function updateStats(mutator){
        if(typeof mutator === 'function'){
          mutator(stats);
        }
        stats.updated = new Date().toISOString();
        saveStats();
        renderStats();
      }

      function resetStats(){
        stats = deepCopy(defaultStats);
        saveStats();
        renderStats();
        showAdminToast('Stats cleared');
      }

      function exportStats(){
        try{
          const snapshot = JSON.stringify(stats, null, 2);
          const blob = new Blob([snapshot], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          anchor.href = url;
          anchor.download = 'tharkibazaar-stats.json';
          document.body.appendChild(anchor);
          anchor.click();
          setTimeout(() => {
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
          }, 0);
          showAdminToast('Stats exported');
        }catch(err){
          console.error('Unable to export stats', err);
          window.alert('Unable to export stats. See console for details.');
        }
      }

      function copySmartlink(){
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(SMARTLINK_URL).then(() => {
            showAdminToast('Smartlink copied');
          }).catch(err => {
            console.error('Failed to copy smartlink', err);
            window.prompt('Copy the smartlink manually:', SMARTLINK_URL);
          });
        }else{
          window.prompt('Copy the smartlink manually:', SMARTLINK_URL);
        }
      }

      function trackDownload(itemId){
        updateStats(state => {
          state.downloads = (state.downloads || 0) + 1;
          if(!state.downloadsPerItem){ state.downloadsPerItem = {}; }
          state.downloadsPerItem[itemId] = (state.downloadsPerItem[itemId] || 0) + 1;
        });
      }

      function trackOutbound(href){
        updateStats(state => {
          state.outboundClicks = (state.outboundClicks || 0) + 1;
        });
      }

      function trackAdImpression(slotId){
        updateStats(state => {
          if(!state.adImpressions){ state.adImpressions = {}; }
          state.adImpressions[slotId] = (state.adImpressions[slotId] || 0) + 1;
        });
      }

      function trackAdClick(slotId){
        updateStats(state => {
          if(!state.adClicks){ state.adClicks = {}; }
          state.adClicks[slotId] = (state.adClicks[slotId] || 0) + 1;
        });
      }

      function clearNode(node){
        while(node.firstChild){
          node.removeChild(node.firstChild);
        }
      }

      function loadAdIntoSlot(slotId, config){
        const container = document.getElementById(slotId);
        if(!container){ return Promise.resolve(); }
        clearNode(container);
        const placeholder = document.createElement('span');
        placeholder.textContent = 'Loading ad�';
        container.appendChild(placeholder);
        return new Promise(resolve => {
          try{
            const configScript = document.createElement('script');
            configScript.type = 'text/javascript';
            configScript.innerHTML = `atOptions = {'key' : '${config.key}','format' : 'iframe','height' : ${config.height},'width' : ${config.width},'params' : {}};`;
            const loader = document.createElement('script');
            loader.type = 'text/javascript';
            loader.async = true;
            loader.src = `//www.highperformanceformat.com/${config.key}/invoke.js`;
            loader.onload = loader.onerror = () => resolve();
            container.appendChild(configScript);
            container.appendChild(loader);
            setTimeout(resolve, 3500);
          }catch(err){
            console.error('Ad load error', err);
            resolve();
          }
        });
      }

      function clearAds(){
        document.querySelectorAll('.ad-slot').forEach(slot => {
          clearNode(slot);
          const placeholder = document.createElement('span');
          placeholder.textContent = 'Advertisement';
          slot.appendChild(placeholder);
        });
      }

      function initAdObserver(){
        if(adObserver){ adObserver.disconnect(); }
        adObserver = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if(entry.isIntersecting && entry.target.id){
              trackAdImpression(entry.target.id);
              adObserver.unobserve(entry.target);
            }
          });
        }, { threshold: 0.5 });
      }

      function registerAdSlots(){
        if(adminMode){ return; }
        if(!adObserver){ initAdObserver(); }
        adObserver.disconnect();
        const slots = document.querySelectorAll('.ad-slot');
        slots.forEach(slot => {
          adObserver.observe(slot);
        });
      }

      function closeAdObserver(){
        if(adObserver){
          adObserver.disconnect();
        }
      }

      function refreshAllAds(){
        if(adminMode){ return; }
        clearAds();
        let queue = Promise.resolve();
        Object.entries(AD_SCHEDULE).forEach(([slotId, config]) => {
          const container = document.getElementById(slotId);
          if(!container){ return; }
          queue = queue.then(() => loadAdIntoSlot(slotId, config));
        });
        queue.then(() => registerAdSlots());
      }

      document.addEventListener('click', event => {
        const anchor = event.target.closest('a[href]');
        if(anchor){
          try{
            const url = new URL(anchor.href, location.href);
            if(url.origin !== location.origin){
              trackOutbound(anchor.href);
            }
          }catch(err){
            // ignore parse errors
          }
        }
        const adSlot = event.target.closest('.ad-slot');
        if(adSlot && !adminMode){
          trackAdClick(adSlot.id || 'ad-slot');
        }
      }, true);

      document.addEventListener('keydown', event => {
        if(event.ctrlKey && event.altKey && event.key){
          const key = event.key.toLowerCase();
          if(key === 'a'){
            event.preventDefault();
            promptAdminLogin();
          }
          if(key === 'l'){
            event.preventDefault();
            lockAdmin();
          }
        }
      });

      (function registerHeaderLongPress(){
        const header = document.querySelector('header');
        if(!header){ return; }
        let timer = null;
        const start = () => {
          timer = setTimeout(() => {
            promptAdminLogin();
          }, 1400);
        };
        const clear = () => {
          if(timer){
            clearTimeout(timer);
            timer = null;
          }
        };
        header.addEventListener('mousedown', start);
        header.addEventListener('mouseup', clear);
        header.addEventListener('mouseleave', clear);
        header.addEventListener('touchstart', start, { passive: true });
        header.addEventListener('touchend', clear);
        header.addEventListener('touchcancel', clear);
      })();

      imageSelect.addEventListener('change', event => {
        populateImageForm(Number(event.target.value));
      });

      imageForm.addEventListener('submit', event => {
        event.preventDefault();
        const index = Number(imageSelect.value);
        if(isNaN(index) || index < 0 || index >= gallery.length){
          window.alert('Invalid selection.');
          return;
        }
        const updated = {
          ...gallery[index],
          title: imageTitleInput.value.trim() || gallery[index].title,
          imageUrl: imageUrlInput.value.trim() || gallery[index].imageUrl,
          downloadUrl: downloadUrlInput.value.trim() || TERABOX_URL,
          imageHint: imageHintInput.value.trim(),
        };
        gallery[index] = updated;
        saveGallery();
        renderGallery();
        renderImageSelect();
        populateImageForm(index);
        if(!adminMode){
          refreshAllAds();
        }
        showAdminToast('Preview updated');
      });

      resetImageButton.addEventListener('click', () => {
        const index = Number(imageSelect.value);
        if(isNaN(index) || index < 0 || index >= DEFAULT_GALLERY.length){
          window.alert('Nothing to reset for this slot.');
          return;
        }
        gallery[index] = deepCopy(DEFAULT_GALLERY[index]);
        saveGallery();
        renderGallery();
        renderImageSelect();
        populateImageForm(index);
        if(!adminMode){
          refreshAllAds();
        }
        showAdminToast('Preview reset to default');
      });

      blurSlider.addEventListener('input', event => {
        const value = Number(event.target.value);
        blurStrength = value;
        applyBlur(value);
        saveBlur(value);
      });

      resetBlurButton.addEventListener('click', () => {
        blurStrength = DEFAULT_BLUR;
        applyBlur(DEFAULT_BLUR);
        saveBlur(DEFAULT_BLUR);
        showAdminToast('Blur strength reset');
      });

      openAdminButton.addEventListener('click', openAdminPanel);
      adminCloseButton.addEventListener('click', closeAdminPanel);
      adminLogoutButton.addEventListener('click', lockAdmin);

      statsCopyButton.addEventListener('click', copySmartlink);
      statsExportButton.addEventListener('click', exportStats);
      statsResetButton.addEventListener('click', () => {
        if(window.confirm('Clear stored activity stats for this browser?')){
          resetStats();
        }
      });
      statsRefreshButton.addEventListener('click', () => {
        if(adminMode){
          showAdminToast('Ads are disabled in admin mode');
          return;
        }
        refreshAllAds();
        showAdminToast('Ad slots refreshed');
      });

      if(ADMIN_PASSWORD === 'Raone'){
        console.warn('TharkiBazaar: Update ADMIN_PASSWORD with your own secret before publishing.');
      }

      applyBlur(blurStrength);
      renderGallery();
      renderImageSelect();
      populateImageForm(selectedImageIndex);
      renderStats();
      updateStats(state => {
        state.visits = (state.visits || 0) + 1;
      });

      if(adminMode){
        setAdminUI(true);
        clearAds();
        closeAdObserver();
        openAdminPanel();
      }else{
        refreshAllAds();
      }

      document.addEventListener('visibilitychange', () => {
        if(document.visibilityState === 'visible' && !adminMode){
          refreshAllAds();
        }
      });
    })();
  </script>
</body>
</html>
